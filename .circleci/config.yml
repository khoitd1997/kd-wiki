version: 2.0
jobs:
  build:
    docker:
      - image: fedora:latest
    steps:
      - add_ssh_keys:
            fingerprints:
              - "46:cf:a0:c7:82:a2:c1:d9:ee:68:6f:ea:99:c6:e4:45"
      - checkout
      - run:
          name: Install mdbook
          command: |
            dnf install -y git libxcrypt-compat curl file @development-tools
            git clone https://github.com/Homebrew/brew ~/.linuxbrew/Homebrew
            mkdir ~/.linuxbrew/bin
            ln -s ~/.linuxbrew/Homebrew/bin/brew ~/.linuxbrew/bin
            eval $(~/.linuxbrew/bin/brew shellenv)
            brew install mdbook

      - run:
          name: Build book
          command: |
            eval $(~/.linuxbrew/bin/brew shellenv)
            rm -rf docs/*
            mdbook build --dest-dir docs

      - run:
          name: Deploy book if master branch
          command: |
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [[ "$BRANCH" != "master" ]]; then
              echo 'Not master';
              exit 1;
            fi

            git config user.email "ci-build@klukas.net" 
            git config user.name "ci-build"
            git push
